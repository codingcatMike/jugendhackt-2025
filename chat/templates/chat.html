{% extends "base.html" %}
{% block title %}Chat mit - {{ chat.user2.username }}{% endblock title %}

{% block content %}
<style>
body { margin:0; padding:0; font-family:sans-serif; height:100vh; overflow:hidden; }
.main-layout { display:flex; height:90vh; }
.chat-list { width:280px; border-right:1px solid #ddd; overflow-y:auto; background:#f5f5f5; }
.chat-list h3 { padding:15px; margin:0; background:#e0e0e0; }
.chat-item { padding:12px 15px; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; }
.chat-item.active { background:#d4f5d0; }
.chat-area { flex:1; display:flex; flex-direction:column; }
.messages-scroll { flex:1; overflow-y:auto; padding:10px 20px 80px; display:flex; flex-direction:column; gap:10px; }
.message { max-width:70%; padding:10px 15px; border-radius:15px; word-wrap:break-word; }
.message-left { background:#f1f1f1; align-self:flex-start; }
.message-right { background:#4CAF50; color:white; align-self:flex-end; }
.chat-input { display:flex; flex-wrap:wrap; gap:10px; padding:10px; border-top:1px solid #ddd; background:#fff; }
.chat-input input[type="text"] { flex:1; padding:10px; border-radius:10px; border:1px solid #ccc; }
.chat-input input[type="file"] { border:none; }
.chat-input button { padding:10px 15px; border-radius:10px; border:none; background:#4CAF50; color:white; cursor:pointer; }
.gif-menu {
  position:absolute; bottom:60px; left:10px; background:white; border:1px solid #ccc; padding:10px;
  border-radius:10px; width:320px; box-shadow:0 3px 10px rgba(0,0,0,0.2); display:none; max-height:300px; overflow-y:auto;
}
.gif-item { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; cursor:pointer; }
.gif-item img { width:100px; border-radius:8px; }
.gif-price { background:#eee; border-radius:8px; padding:3px 8px; font-size:13px; margin-left:10px; }
.error-msg { color:red; font-size:13px; margin-left:10px; }
.keygen-btn { margin:10px; background-color:#007BFF; color:white; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
.log-note { margin:8px 15px; font-size:12px; color:#666; }
</style>

<!-- Hidden coin element, reads from ForeignKey -->
<!-- Hidden element for JS -->
<div id="coinCount" style="display:none;">
  {% if user.coinaccount_set.exists %}
    {{ user.coinaccount_set.all.0.coins }}
  {% else %}
    0
  {% endif %}
</div>


<div class="main-layout">
  <div class="chat-list" id="chatList">
    <h3>Chats</h3>
    {% for c in user_chats %}
      <div class="chat-item {% if c.id == chat.id %}active{% endif %}" data-chat-id="{{ c.id }}">
        <span>{% if user == c.user1 %}{{ c.user2.username }}{% else %}{{ c.user1.username }}{% endif %}</span>
        <small>{{ c.last_activity|date:"H:i" }}</small>
      </div>
    {% empty %}
      <p style="padding:10px;">Keine Chats vorhanden.</p>
    {% endfor %}
  </div>

  <div class="chat-area">
    <button class="keygen-btn" id="generateKeysBtn">ðŸ”‘ Generate / Upload Keys</button>
    <div class="log-note">Tip: use this button to (re)generate or upload keys, useful if decryption fails.</div>

    <div class="messages-scroll" id="chatContainer">
      {% for message in messages %}
        <div class="message {% if message.sender == user %}message-right{% else %}message-left{% endif %}">
          {% if message.media %}
            <img src="{{ message.media.url }}" width="120">
          {% else %}
            <strong>{{ message.sender.username }}:</strong>
            <span>{{ message.content }}</span>
          {% endif %}
          <em>({{ message.timestamp }})</em>
        </div>
      {% endfor %}
    </div>

    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Schreibe eine Nachricht...">
      <input type="file" id="mediaInput" accept="image/*">
      <button id="gifShopBtn">ðŸª™ GIFs</button>
      <button id="sendBtn">ðŸ“¨</button>

      <div class="gif-menu" id="gifMenu"></div>
      <span class="error-msg" id="errorMsg"></span>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Chat list
  const chatList = document.getElementById("chatList");
  Array.from(chatList.querySelectorAll(".chat-item")).forEach(c => {
    c.addEventListener("click", () => window.location.href = `/chat/${c.dataset.chatId}/`);
  });

  // Coins
let coinCountEl = document.getElementById("coinCount");
let userCoins = coinCountEl ? parseInt(coinCountEl.textContent) : 0;
console.log("User coins:", userCoins); // should now show actual coins


  const chatContainer = document.getElementById("chatContainer");
  const errorMsg = document.getElementById("errorMsg");

  // WebSocket
  const chatId = "{{ chat.id }}";
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${chatId}/`);

  const messageInput = document.getElementById("messageInput");
  const mediaInput = document.getElementById("mediaInput");
  const sendBtn = document.getElementById("sendBtn");
  const gifBtn = document.getElementById("gifShopBtn");
  const gifMenu = document.getElementById("gifMenu");

  // Receive messages
  chatSocket.onmessage = function(e){
    const data = JSON.parse(e.data);
    if(data.error || !data.sender) return;
    if(data.sender === "{{ user.username }}") return;

    const msgEl = document.createElement("div");
    msgEl.className = "message message-left";
    if(data.media){
      msgEl.innerHTML = `<img src="${data.media}" width="120"><em>${data.sender}</em>`;
    } else {
      msgEl.innerHTML = `<strong>${data.sender}:</strong> <span>${data.encrypted_message}</span> <em>(${data.timestamp})</em>`;
    }
    chatContainer.appendChild(msgEl);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  };

  // Send text or media
  sendBtn.addEventListener("click", () => {
    const msg = messageInput.value.trim();
    const mediaFile = mediaInput.files[0];

    if(!msg && !mediaFile) return;

    if(mediaFile){
      const reader = new FileReader();
      reader.onload = function(){
        const payload = {
          media: reader.result,
          encrypted_key_recipient: "dummy_recipient_key",
          encrypted_key_sender: "dummy_sender_key",
          iv: "dummy_iv"
        };
        chatSocket.send(JSON.stringify(payload));

        const msgEl = document.createElement("div");
        msgEl.className = "message message-right";
        msgEl.innerHTML = `<img src="${URL.createObjectURL(mediaFile)}" width="120"><em>(Du)</em>`;
        chatContainer.appendChild(msgEl);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      };
      reader.readAsDataURL(mediaFile);
    } else {
      const payload = {
        encrypted_message: msg,
        encrypted_key_recipient: "dummy_recipient_key",
        encrypted_key_sender: "dummy_sender_key",
        iv: "dummy_iv"
      };
      chatSocket.send(JSON.stringify(payload));

      const msgEl = document.createElement("div");
      msgEl.className = "message message-right";
      msgEl.innerHTML = `<strong>{{ user.username }}:</strong> <span>${msg}</span> <em>(jetzt)</em>`;
      chatContainer.appendChild(msgEl);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    messageInput.value = "";
    mediaInput.value = "";
  });

  messageInput.addEventListener("keyup", e => { if(e.key === "Enter") sendBtn.click(); });

  // GIF shop
  gifBtn.addEventListener("click", async () => {
    if(gifMenu.style.display === "block"){ gifMenu.style.display="none"; return; }

    const res = await fetch("/api/gifs/");
    const gifs = await res.json();
    gifMenu.innerHTML = gifs.map(gif => `
      <div class="gif-item" data-url="${gif.url}" data-price="${gif.price}">
        <img src="${gif.url}" alt="${gif.name}"><span class="gif-price">ðŸª™ ${gif.price}</span>
      </div>
    `).join("");
    gifMenu.style.display = "block";

    gifMenu.querySelectorAll(".gif-item").forEach(item=>{
      item.addEventListener("click", ()=>{
        const price = parseInt(item.dataset.price);
        const url = item.dataset.url;

        console.log("Clicked GIF:", url, "Price:", price, "User coins before:", userCoins);

        if(userCoins < price){
          console.error("Not enough coins!", userCoins, "<", price);
          errorMsg.textContent = "Nicht genÃ¼gend Coins!";
          return;
        }

        fetch(url)
          .then(res => res.blob())
          .then(blob => {
            const reader = new FileReader();
            reader.onload = function() {
              const payload = {
                media: reader.result,
                encrypted_key_recipient: "dummy_recipient_key",
                encrypted_key_sender: "dummy_sender_key",
                iv: "dummy_iv"
              };
              chatSocket.send(JSON.stringify(payload));
              userCoins -= price;
              if(coinCountEl) coinCountEl.textContent = userCoins;

              const msgEl = document.createElement("div");
              msgEl.className = "message message-right";
              msgEl.innerHTML = `<img src="${url}" width="120"><em>(ðŸª™ Geschenk!)</em>`;
              chatContainer.appendChild(msgEl);
              chatContainer.scrollTop = chatContainer.scrollHeight;

              gifMenu.style.display="none";
              errorMsg.textContent="";
            };
            reader.readAsDataURL(blob);
          })
          .catch(err => {
            console.error("GIF fetch/load error:", err);
            errorMsg.textContent = "Fehler beim Laden der GIF-Datei!";
          });
      });
    });
  });

});
</script>
{% endblock content %}
