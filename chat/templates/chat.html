{% extends "base.html" %}
{% block title %}Chat mit - {{ chat.user2.username }}{% endblock title %}
{% load static %}
{% block content %}
<style>
body { margin:0; padding:0; font-family:sans-serif; height:100vh; overflow:hidden; }
.main-layout { display:flex; height:93vh; }
.chat-list { width:280px; border-right:1px solid #ddd; overflow-y:auto; background:#f5f5f5; }
.chat-list h3 { padding:15px; margin:0; background:#e0e0e0; }
.chat-item { padding:12px 15px; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; }
.chat-item.active { background:#d4f5d0; }
.chat-area { flex:1; display:flex; flex-direction:column; background-color: #dddddd9c; }
.header-row { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #ddd; background:#fff; }
.messages-scroll { flex:1; overflow-y:auto; padding:10px 20px 80px; display:flex; flex-direction:column; gap:10px; }
.message { max-width:70%; padding:10px 15px; border-radius:15px; word-wrap:break-word; }
.message-left { background: #f1f1f1; align-self:flex-start; }
.message-right { background: #9cbeff; color:white; align-self:flex-end; }
.chat-input { display:flex; flex-wrap:wrap; gap:10px; padding:10px; border-top:1px solid #ddd; background:#fff; }
.chat-input input[type="text"] { flex:1; padding:10px; border-radius:10px; border:1px solid #ccc; }
.chat-input input[type="file"] { border:none; }
.chat-input button { padding:10px 15px; border-radius:10px; border:none; background: #9cbeff; color:white; cursor:pointer;}
.gif-menu {
  position:absolute; bottom:60px; left:10px; background:white; border:1px solid #ccc; padding:10px;
  border-radius:10px; width:320px; box-shadow:0 3px 10px rgba(0,0,0,0.2); display:none; max-height:300px; overflow-y:auto;
}
.gif-item { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; cursor:pointer; }
.gif-item img { width:100px; border-radius:8px; }
.gif-price { background:#eee; border-radius:8px; padding:3px 8px; font-size:13px; margin-left:10px; }
.error-msg { color:red; font-size:13px; margin-left:10px; }
.keygen-btn { margin:10px; background-color:#007BFF; color:white; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
.log-note { margin:8px 15px; font-size:12px; color:#666; }
.file-upload-wrapper { display: flex; align-items: center; gap: 10px; }
.file-upload-btn { background-color: #9cbeff; color: white; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 14px; border: none; display: inline-block; }
.file-upload-btn:hover { background-color: #9cbeff; }
#mediaInput { display: none; }
.file-name { font-size: 13px; color: #666; }
.coin-box { display:flex; align-items:center; gap:10px; }
.coin-count { background:#ffefc6; padding:6px 10px; border-radius:8px; font-weight:600; }
</style>

<div id="coinCount" style="display:none;">
 {% with user.profile_set.first as profile %}
    {% if profile %}
        {{ profile.coins }}
  {% else %}
    0
  {% endif %}
  {% endwith %}
</div>

<div class="main-layout">
  <div class="chat-list" id="chatList">
    <h3>Chats</h3>
    {% for c in user_chats %}
    <div class="chat-item {% if c.id == chat.id %}active{% endif %}"
        data-chat-id="{{ c.id }}"
        {% if c.last_msg_time %}data-last-activity="{{ c.last_msg_time|date:'Y-m-d H:i:s' }}"{% endif %}>
      <span>{% if user == c.user1 %}{{ c.user2.username }}{% else %}{{ c.user1.username }}{% endif %}</span>
      <small>
        {% if c.last_msg_time %}
          {{ c.last_msg_time|date:"d.m.Y H:i" }}
        {% else %}
          Kein Verlauf
        {% endif %}
      </small>
    </div>


    {% empty %}
      <p style="padding:10px;">Keine Chats vorhanden.</p>
    {% endfor %}
    <button id="startChatBtn" onclick="window.location.href='{% url 'start_chat' %}'" style="margin:10px; padding:8px 12px; border:none; border-radius:8px; background:#9cbeff; color:white; cursor:pointer;">Neuen Chat starten</button>
  </div>

  <div class="chat-area">
    <div class="header-row">
      <div>
        <button class="keygen-btn" id="generateKeysBtn">ðŸ”‘ Generate / Upload Keys</button>
        <div class="log-note">Tipp: (Re)generate oder upload keys wenn EntschlÃ¼sselung fehlschlÃ¤gt.</div>
      </div>
      {% if chat.activated == False %}
      {% if chat.user2 == request.user %}
        <div style="color:green; font-weight:600;">Dieser Chat ist noch nicht aktiviert! Bitte bestÃ¤tige den Chat, um Nachrichten zu senden.</div>
        <button onclick="window.location.href='{% url 'activate_chat' chat.id %}'" style="margin-left:10px; padding:6px 10px; border:none; border-radius:8px; background:#9cbeff; color:white; cursor:pointer;">Chat bestÃ¤tigen</button>
      
        {% else %}
      <div style="color:red; font-weight:600;">Dieser Chat ist noch nicht aktiviert! Bitte warte auf die BestÃ¤tigung des anderen Nutzers.</div>
      {% endif %}
      {% endif %}
      <div class="coin-box">
        <div>Deine Coins:</div>
        <div id="coinDisplay" class="coin-count">0</div>
      </div>
    </div>

    <div class="messages-scroll" id="chatContainer">
      {% for message in messages %}
        <div class="message {% if message.sender == user %}message-right{% else %}message-left{% endif %}">
          {% if message.media %}
            <img src="{{ message.media.url }}" width="120">
          {% else %}
            <strong>{{ message.sender.username }}:</strong>
            <span>{{ message.content }}</span>
          {% endif %}
          <em>({{ message.timestamp }})</em>
        </div>
      {% endfor %}
    </div>

    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Schreibe eine Nachricht...">
      <div class="file-upload-wrapper">
        <label for="mediaInput" class="file-upload-btn">ðŸ“Ž Bild auswÃ¤hlen</label>
        <input type="file" id="mediaInput" accept="image/*">
        <span class="file-name" id="fileName"></span>
      </div>
      <button id="gifShopBtn">ðŸª™ GIFs</button>
      <button id="sendBtn" title="Senden">
        <img src="{% static 'images/flyer.png' %}" alt="Send" style=" width:40px; height:40px;">
      </button>
      <div class="gif-menu" id="gifMenu"></div>
      <span class="error-msg" id="errorMsg"></span>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const chatList = document.getElementById("chatList");
  Array.from(chatList.querySelectorAll(".chat-item")).forEach(c => {
    c.addEventListener("click", () => window.location.href = `/chat/${c.dataset.chatId}`);
  });

  // === CHAT REMINDER SYSTEM ===
// === CHAT REMINDER SYSTEM ===
(function remindInactiveChats() {
  const chatItems = Array.from(document.querySelectorAll(".chat-item"));
  if (chatItems.length === 0) return;

  // Collect inactive chats
  const inactiveChats = chatItems
    .map(c => {
      const lastActivityStr = c.dataset.lastActivity;
      if (!lastActivityStr) return null;
      const lastActivity = new Date(lastActivityStr.replace(" ", "T")); // parse "Y-m-d H:i:s"
      if (isNaN(lastActivity)) return null;
      return { el: c, lastActivity };
    })
    .filter(Boolean)
    .filter(c => {
      const now = new Date();
      const diffDays = (now - c.lastActivity) / (1000 * 60 * 60 * 24);
      return diffDays >= 7; // inactive for 7+ days
    });

  if (inactiveChats.length === 0) return;

  // Pick a random inactive chat
  const randomChat = inactiveChats[Math.floor(Math.random() * inactiveChats.length)];
  const username = randomChat.el.querySelector("span")?.textContent || "jemandem";

  // Create a reminder box
  const reminder = document.createElement("div");
  reminder.style.background = "#fff8c6";
  reminder.style.padding = "10px";
  reminder.style.margin = "10px";
  reminder.style.borderRadius = "8px";
  reminder.style.fontSize = "14px";
  reminder.style.cursor = "pointer";
  reminder.style.border = "1px solid #e2c300";
  reminder.innerHTML = `ðŸ’¬ Du hast seit Ã¼ber einer Woche nicht mit <strong>${username}</strong> geschrieben.<br><small>Klicke hier, um den Chat zu Ã¶ffnen!</small>`;

  reminder.addEventListener("click", () => {
    const chatId = randomChat.el.dataset.chatId;
    if (chatId) window.location.href = `/chat/${chatId}`;
  });

  // Insert reminder at top of chat list
  const chatList = document.getElementById("chatList");
  chatList.insertBefore(reminder, chatList.children[1]);
})();


  let coinCountEl = document.getElementById("coinCount");
  let userCoins = coinCountEl ? parseInt(coinCountEl.textContent || "0") : 0;
  const coinDisplay = document.getElementById("coinDisplay");
  coinDisplay.textContent = userCoins;

  const chatContainer = document.getElementById("chatContainer");
  const errorMsg = document.getElementById("errorMsg");

  function scrollToBottom() {
    if (!chatContainer) return;
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }
  setTimeout(scrollToBottom, 100);

  const chatId = "{{ chat.id }}";
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${chatId}/`);

  const messageInput = document.getElementById("messageInput");
  const mediaInput = document.getElementById("mediaInput");
  const sendBtn = document.getElementById("sendBtn");
  const gifBtn = document.getElementById("gifShopBtn");
  const gifMenu = document.getElementById("gifMenu");
  const fileName = document.getElementById("fileName");

  chatSocket.onmessage = function(e) {
    try {
      const data = JSON.parse(e.data);
      if (data.error) { errorMsg.textContent = data.error; return; }
      if (typeof data.coins !== "undefined") {
        userCoins = parseInt(data.coins);
        if (!isNaN(userCoins)) { coinDisplay.textContent = userCoins; if (coinCountEl) coinCountEl.textContent = userCoins; }
        errorMsg.textContent = "";
        return;
      }
      if (!data.sender) return;
      const msgEl = document.createElement("div");
      const isOwn = data.sender === "{{ user.username }}";
      msgEl.className = "message " + (isOwn ? "message-right" : "message-left");
      if (data.media) {
        msgEl.innerHTML = `<img src="${data.media}" width="120"><em>${data.sender}</em> <em>(${data.timestamp})</em>`;
      } else {
        msgEl.innerHTML = `<strong>${data.sender}:</strong> <span>${data.encrypted_message}</span> <em>(${data.timestamp})</em>`;
      }
      chatContainer.appendChild(msgEl);
      scrollToBottom();
      errorMsg.textContent = "";
    } catch (err) { console.error("WS onmessage parse error:", err); }
  };

  chatSocket.onopen = () => console.log("WebSocket connected");
  chatSocket.onclose = () => console.log("WebSocket closed");

  sendBtn.addEventListener("click", () => {
    const msg = messageInput.value.trim();
    const mediaFile = mediaInput.files[0];
    if (!msg && !mediaFile) return;
    errorMsg.textContent = "";

    if (mediaFile) {
      const reader = new FileReader();
      reader.onload = function() {
        chatSocket.send(JSON.stringify({
          media: reader.result,
          media_type: "image",
          encrypted_key_recipient: "dummy_recipient_key",
          encrypted_key_sender: "dummy_sender_key",
          iv: "dummy_iv"
        }));
        scrollToBottom();
      };
      reader.readAsDataURL(mediaFile);
    } else {
      chatSocket.send(JSON.stringify({
        encrypted_message: msg,
        encrypted_key_recipient: "dummy_recipient_key",
        encrypted_key_sender: "dummy_sender_key",
        iv: "dummy_iv"
      }));
      scrollToBottom();
    }

    messageInput.value = "";
    mediaInput.value = "";
    fileName.textContent = "";
  });

  messageInput.addEventListener("keyup", e => { if (e.key === "Enter") sendBtn.click(); });

  gifBtn.addEventListener("click", async () => {
    if (gifMenu.style.display === "block") { gifMenu.style.display = "none"; return; }
    try {
      const res = await fetch("/api/gifs/");
      if (!res.ok) throw new Error("Fehler beim Laden der GIF-Liste");
      const gifs = await res.json();
      gifMenu.innerHTML = gifs.map(gif => `
        <div class="gif-item" data-url="${gif.url}" data-price="${gif.price}">
          <img src="${gif.url}" alt="${gif.name}"><span class="gif-price">ðŸª™ ${gif.price}</span>
        </div>
      `).join("");
      gifMenu.style.display = "block";
      gifMenu.querySelectorAll(".gif-item").forEach(item => {
        item.addEventListener("click", async () => {
          const price = parseInt(item.dataset.price);
          const url = item.dataset.url;
          if (userCoins < price) { errorMsg.textContent = "Nicht genÃ¼gend Coins!"; return; }
          errorMsg.textContent = "Sende GIF...";
          gifMenu.style.display = "none";
          try {
            const res = await fetch(url);
            if (!res.ok) throw new Error("Fehler beim Laden des GIFs");
            const blob = await res.blob();
            const reader = new FileReader();
            reader.onload = function() {
              chatSocket.send(JSON.stringify({
                media: reader.result,
                media_type: "gif",
                price: price,
                encrypted_key_recipient: "dummy_recipient_key",
                encrypted_key_sender: "dummy_sender_key",
                iv: "dummy_iv"
              }));
              errorMsg.textContent = "";
              scrollToBottom();
            };
            reader.readAsDataURL(blob);
          } catch (err) { console.error("GIF fetch/load error:", err); errorMsg.textContent = "Fehler beim Laden der GIF-Datei!"; }
        });
      });
    } catch (err) { console.error("GIF shop load error:", err); errorMsg.textContent = "Fehler beim Laden der GIFs."; }
  });

  mediaInput.addEventListener("change", () => { fileName.textContent = mediaInput.files.length > 0 ? mediaInput.files[0].name : ""; });

  // === RSA KEY GENERATION & UPLOAD ===
  generateKeysBtn.addEventListener("click", () => {
    console.log("ðŸŸ¦ [KeyGen] Button clicked â€” generating & uploading keys");
    generateAndUploadKeys();
  });

  async function generateAndUploadKeys() {
    const username = "{{ user.username }}";
    const chatId = "{{ chat.id }}";
    const uploadUrl = "/upload_public_key/";
    console.log("ðŸ”‘ Starting key generation for:", username, "in chat", chatId);
    try {
      const keyPair = await window.crypto.subtle.generateKey(
        { name: "RSA-OAEP", modulusLength: 2048, publicExponent: new Uint8Array([1,0,1]), hash:"SHA-256" },
        true, ["encrypt","decrypt"]
      );
      console.log("âœ… Keypair generated.");
      const publicKeyBuffer = await crypto.subtle.exportKey("spki", keyPair.publicKey);
      const privateKeyBuffer = await crypto.subtle.exportKey("pkcs8", keyPair.privateKey);
      console.log("ðŸ“¤ Keys exported to ArrayBuffers.");
      const publicKeyB64 = arrayBufferToBase64(publicKeyBuffer);
      const privateKeyB64 = arrayBufferToBase64(privateKeyBuffer);
      console.log("ðŸ”¡ Keys encoded in Base64.");
      localStorage.setItem("privateKey_" + username, privateKeyB64);
      localStorage.setItem("publicKey_" + username, publicKeyB64);
      console.log("ðŸ’¾ Keys stored in localStorage as:", "privateKey_" + username);
      console.log("ðŸŒ Uploading public key to server...");
      const res = await fetch(uploadUrl, {
        method:"POST",
        headers:{ "Content-Type":"application/json","X-CSRFToken": getCSRFToken() },
        body: JSON.stringify({ username, chat_id:chatId, public_key:publicKeyB64, algorithm:"RSA-OAEP-2048-SHA256" })
      });
      if(!res.ok){ const text=await res.text(); console.error("âŒ Upload failed:", text); alert("Fehler beim Upload: "+res.status+" â€” siehe Konsole."); return; }
      const result=await res.json();
      console.log("âœ… Upload success:", result);
      alert("Keys generated & uploaded âœ“");
    } catch(err){ console.error("ðŸš¨ Fehler bei der SchlÃ¼sselgenerierung / Upload:", err); alert("Fehler bei der SchlÃ¼sselgenerierung / Upload: "+err.message); }
  }

  function arrayBufferToBase64(buffer){ const bytes=new Uint8Array(buffer); let binary=""; bytes.forEach(b=>binary+=String.fromCharCode(b)); return window.btoa(binary); }
  function getCSRFToken(){ const cookieValue=document.cookie.split("; ").find(row=>row.startsWith("csrftoken=")); return cookieValue?cookieValue.split("=")[1]:""; }

});
</script>
{% endblock content %}
