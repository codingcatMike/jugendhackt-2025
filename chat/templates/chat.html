{% extends "base.html" %}
{% block title %}Chat mit - {{ chat.user2.username }}{% endblock title %}
{% load static %}
{% block content %}
<style>
/* (wie vorher, gleiche Styles + kleine Anpassung fÃ¼r coin display) */
body { margin:0; padding:0; font-family:sans-serif; height:100vh; overflow:hidden; }
.main-layout { display:flex; height:90vh; }
.chat-list { width:280px; border-right:1px solid #ddd; overflow-y:auto; background:#f5f5f5; }
.chat-list h3 { padding:15px; margin:0; background:#e0e0e0; }
.chat-item { padding:12px 15px; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; }
.chat-item.active { background:#d4f5d0; }
.chat-area { flex:1; display:flex; flex-direction:column; background-color: #dddddd9c; }
.header-row { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #ddd; background:#fff; }
.messages-scroll { flex:1; overflow-y:auto; padding:10px 20px 80px; display:flex; flex-direction:column; gap:10px; }
.message { max-width:70%; padding:10px 15px; border-radius:15px; word-wrap:break-word; }
.message-left { background: #f1f1f1; align-self:flex-start; }
.message-right { background: #9cbeff; color:white; align-self:flex-end; }
.chat-input { display:flex; flex-wrap:wrap; gap:10px; padding:10px; border-top:1px solid #ddd; background:#fff; }
.chat-input input[type="text"] { flex:1; padding:10px; border-radius:10px; border:1px solid #ccc; }
.chat-input input[type="file"] { border:none; }
.chat-input button { padding:10px 15px; border-radius:10px; border:none; background: #9cbeff; color:white; cursor:pointer;}
.gif-menu {
  position:absolute; bottom:60px; left:10px; background:white; border:1px solid #ccc; padding:10px;
  border-radius:10px; width:320px; box-shadow:0 3px 10px rgba(0,0,0,0.2); display:none; max-height:300px; overflow-y:auto;
}
.gif-item { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; cursor:pointer; }
.gif-item img { width:100px; border-radius:8px; }
.gif-price { background:#eee; border-radius:8px; padding:3px 8px; font-size:13px; margin-left:10px; }
.error-msg { color:red; font-size:13px; margin-left:10px; }
.keygen-btn { margin:10px; background-color:#007BFF; color:white; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
.log-note { margin:8px 15px; font-size:12px; color:#666; }
.file-upload-wrapper { display: flex; align-items: center; gap: 10px; }
.file-upload-btn { background-color: #9cbeff; color: white; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 14px; border: none; display: inline-block; }
.file-upload-btn:hover { background-color: #9cbeff; }
#mediaInput { display: none; }
.file-name { font-size: 13px; color: #666; }

/* coin display */
.coin-box { display:flex; align-items:center; gap:10px; }
.coin-count { background:#ffefc6; padding:6px 10px; border-radius:8px; font-weight:600; }
</style>

<!-- Hidden coin element is still here as data source -->
<div id="coinCount" style="display:none;">
 {% with user.profile_set.first as profile %}
    {% if profile %}
        {{ profile.coins }}
  {% else %}
    0
  {% endif %}
  {% endwith %}
</div>

<div class="main-layout">
  <div class="chat-list" id="chatList">
    <h3>Chats</h3>
    {% for c in user_chats %}
      <div class="chat-item {% if c.id == chat.id %}active{% endif %}" data-chat-id="{{ c.id }}">
        <span>{% if user == c.user1 %}{{ c.user2.username }}{% else %}{{ c.user1.username }}{% endif %}</span>
        <small>{{ c.last_activity|date:"H:i" }}</small>
      </div>
    {% empty %}
      <p style="padding:10px;">Keine Chats vorhanden.</p>
    {% endfor %}
  </div>

  <div class="chat-area">
    <div class="header-row">
      <div>
        <button class="keygen-btn" id="generateKeysBtn">ðŸ”‘ Generate / Upload Keys</button>
        <div class="log-note">Tipp: (Re)generate oder upload keys wenn EntschlÃ¼sselung fehlschlÃ¤gt.</div>
      </div>
      <div class="coin-box">
        <div>Deine Coins:</div>
        <div id="coinDisplay" class="coin-count">0</div>
      </div>
    </div>

    <div class="messages-scroll" id="chatContainer">
      {% for message in messages %}
        <div class="message {% if message.sender == user %}message-right{% else %}message-left{% endif %}">
          {% if message.media %}
            <img src="{{ message.media.url }}" width="120">
          {% else %}
            <strong>{{ message.sender.username }}:</strong>
            <span>{{ message.content }}</span>
          {% endif %}
          <em>({{ message.timestamp }})</em>
        </div>
      {% endfor %}
    </div>

    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Schreibe eine Nachricht...">

      <div class="file-upload-wrapper">
        <label for="mediaInput" class="file-upload-btn">ðŸ“Ž Bild auswÃ¤hlen</label>
        <input type="file" id="mediaInput" accept="image/*">
        <span class="file-name" id="fileName"></span>
      </div>

      <button id="gifShopBtn">ðŸª™ GIFs</button>
      <button id="sendBtn" title="Senden">
        <img src="{% static 'images/flyer.png' %}" alt="Send" style=" width:40px; height:40px;">
      </button>

      <div class="gif-menu" id="gifMenu"></div>
      <span class="error-msg" id="errorMsg"></span>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Chat list navigation
  const chatList = document.getElementById("chatList");
  Array.from(chatList.querySelectorAll(".chat-item")).forEach(c => {
    c.addEventListener("click", () => window.location.href = `/chat/${c.dataset.chatId}`);
  });

  // Coins: initial lesen
  let coinCountEl = document.getElementById("coinCount");
  let userCoins = coinCountEl ? parseInt(coinCountEl.textContent || "0") : 0;
  const coinDisplay = document.getElementById("coinDisplay");
  coinDisplay.textContent = userCoins;

  const chatContainer = document.getElementById("chatContainer");
  const errorMsg = document.getElementById("errorMsg");

  // WebSocket aufsetzen
  const chatId = "{{ chat.id }}";
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${chatId}/`);

  const messageInput = document.getElementById("messageInput");
  const mediaInput = document.getElementById("mediaInput");
  const sendBtn = document.getElementById("sendBtn");
  const gifBtn = document.getElementById("gifShopBtn");
  const gifMenu = document.getElementById("gifMenu");
  const fileName = document.getElementById("fileName");

  // WebSocket: Empfangs-Handler
  chatSocket.onmessage = function(e) {
    try {
      const data = JSON.parse(e.data);
      // Fehler vom Server
      if (data.error) {
        errorMsg.textContent = data.error;
        return;
      }

      // Coin-Update (nur an Absender gesendet)
      if (typeof data.coins !== "undefined") {
        userCoins = parseInt(data.coins);
        if (!isNaN(userCoins)) {
          coinDisplay.textContent = userCoins;
          if (coinCountEl) coinCountEl.textContent = userCoins;
        }
        errorMsg.textContent = ""; // evtl vorherige Fehler ausblenden
        return;
      }

      // Ankommende Nachricht (Broadcast)
      // PrÃ¼fen, ob Payload die Nachricht-Felder enthÃ¤lt
      if (!data.sender) return;

      // Nachricht erzeugen und hinzufÃ¼gen
      const msgEl = document.createElement("div");
      // anhand des Senders klassifizieren
      const isOwn = data.sender === "{{ user.username }}";
      msgEl.className = "message " + (isOwn ? "message-right" : "message-left");

      if (data.media) {
        msgEl.innerHTML = `<img src="${data.media}" width="120"><em>${data.sender}</em> <em>(${data.timestamp})</em>`;
      } else {
        msgEl.innerHTML = `<strong>${data.sender}:</strong> <span>${data.encrypted_message}</span> <em>(${data.timestamp})</em>`;
      }

      chatContainer.appendChild(msgEl);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      errorMsg.textContent = "";
    } catch (err) {
      console.error("WS onmessage parse error:", err);
    }
  };

  chatSocket.onopen = function() {
    console.log("WebSocket connected");
  };
  chatSocket.onclose = function() {
    console.log("WebSocket closed");
  };

  // SEND: Text oder Upload (keine lokale Anzeige, Anzeige kommt durch Server-Broadcast)
  sendBtn.addEventListener("click", () => {
    const msg = messageInput.value.trim();
    const mediaFile = mediaInput.files[0];

    if (!msg && !mediaFile) return;

    errorMsg.textContent = "";

    if (mediaFile) {
      const reader = new FileReader();
      reader.onload = function() {
        const payload = {
          media: reader.result,
          media_type: "image",
          encrypted_key_recipient: "dummy_recipient_key",
          encrypted_key_sender: "dummy_sender_key",
          iv: "dummy_iv"
        };
        chatSocket.send(JSON.stringify(payload));
      };
      reader.readAsDataURL(mediaFile);
    } else {
      const payload = {
        encrypted_message: msg,
        encrypted_key_recipient: "dummy_recipient_key",
        encrypted_key_sender: "dummy_sender_key",
        iv: "dummy_iv"
      };
      chatSocket.send(JSON.stringify(payload));
    }

    // Felder zurÃ¼cksetzen (Anzeige erfolgt durch Server)
    messageInput.value = "";
    mediaInput.value = "";
    fileName.textContent = "";
  });

  // Enter zum Senden
  messageInput.addEventListener("keyup", e => { if (e.key === "Enter") sendBtn.click(); });

  // GIF-Shop: lÃ¤dt GIF-Liste und Ã¶ffnet MenÃ¼
  gifBtn.addEventListener("click", async () => {
    if (gifMenu.style.display === "block") { gifMenu.style.display = "none"; return; }

    try {
      const res = await fetch("/api/gifs/");
      if (!res.ok) throw new Error("Fehler beim Laden der GIF-Liste");
      const gifs = await res.json();

      gifMenu.innerHTML = gifs.map(gif => `
        <div class="gif-item" data-url="${gif.url}" data-price="${gif.price}">
          <img src="${gif.url}" alt="${gif.name}"><span class="gif-price">ðŸª™ ${gif.price}</span>
        </div>
      `).join("");
      gifMenu.style.display = "block";

      // Klick-Handler fÃ¼r GIF-Items
      gifMenu.querySelectorAll(".gif-item").forEach(item => {
        item.addEventListener("click", async () => {
          const price = parseInt(item.dataset.price);
          const url = item.dataset.url;

          // Client-seitige Abfrage der Coins vor dem Versuch (nur als UX-Hinweis)
          if (userCoins < price) {
            errorMsg.textContent = "Nicht genÃ¼gend Coins!";
            return;
          }

          // Lade das GIF, konvertiere in base64 und sende an Server.
          errorMsg.textContent = "Sende GIF...";
          gifMenu.style.display = "none";

          try {
            const res = await fetch(url);
            if (!res.ok) throw new Error("Fehler beim Laden des GIFs");
            const blob = await res.blob();
            const reader = new FileReader();
            reader.onload = function() {
              const payload = {
                media: reader.result,
                media_type: "gif",
                price: price,
                encrypted_key_recipient: "dummy_recipient_key",
                encrypted_key_sender: "dummy_sender_key",
                iv: "dummy_iv"
              };
              // Senden â€” coin Abzug passiert serverseitig
              chatSocket.send(JSON.stringify(payload));
              // Warte auf serverseitige BestÃ¤tigung (coins update) und Broadcast der Nachricht
              errorMsg.textContent = ""; // zurÃ¼cksetzen, Server meldet ggf. Fehler
            };
            reader.readAsDataURL(blob);
          } catch (err) {
            console.error("GIF fetch/load error:", err);
            errorMsg.textContent = "Fehler beim Laden der GIF-Datei!";
          }
        });
      });

    } catch (err) {
      console.error("GIF shop load error:", err);
      errorMsg.textContent = "Fehler beim Laden der GIFs.";
    }
  });

  // File input: Zeige Dateinamen
  mediaInput.addEventListener("change", () => {
    if (mediaInput.files.length > 0) {
      fileName.textContent = mediaInput.files[0].name;
    } else {
      fileName.textContent = "";
    }
  });

  // Keygen Button (placeholder, Verhalten wie zuvor)
  const generateKeysBtn = document.getElementById("generateKeysBtn");
  generateKeysBtn.addEventListener("click", () => {
    alert("Generate/Upload keys â€” hier dein vorhandener Flow einbauen.");
  });

});
</script>
{% endblock content %}
